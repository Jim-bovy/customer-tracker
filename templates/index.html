<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      #chart-container {
        max-width: 30%;
        margin: auto;
        position: relative;
        height: 300px;
      }
    </style>
</head>
<body class="container mt-4">

    <h1 class="mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>

    {% if due_today and due_today|length > 0 %}
        <div class="alert alert-danger">
            üì¢ <strong>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {{ due_today|length }} ‡∏Ñ‡∏ô!</strong><br>
            <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</span>
            <ul class="mt-2 mb-0">
                {% for row in due_today %}
                    <li>{{ row[1] }} - {{ row[2] }} (‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ row[6] }})</li>
                {% endfor %}
            </ul>
        </div>

        <!-- ‚úÖ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
        <audio id="alertSound" autoplay>
            <source src="{{ url_for('static', filename='alert.mp3') }}" type="audio/mpeg">
            ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        </audio>
        <script>
            window.addEventListener('DOMContentLoaded', function () {
                const sound = document.getElementById('alertSound');
                if (sound) {
                    sound.play().catch(function (err) {
                        console.warn("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:", err);
                    });
                }
            });
        </script>
    {% endif %}

    <div class="mb-5">
        <h5>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h5>
        <div id="chart-container">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <form method="post" action="/add" class="row g-2 mb-4">
        <div class="col-md-2"><input type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="form-control" required></div>
        <div class="col-md-2"><input type="tel" name="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" pattern="[0-9]{9,10}" class="form-control" required></div>
        <div class="col-md-2"><input type="text" name="location" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" class="form-control"></div>
        <div class="col-md-1"><input type="number" name="price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="form-control" min="0"></div>
        <div class="col-md-2">
            <select name="status" class="form-select">
                <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                <option value="‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</option>
                <option value="‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
            </select>
        </div>
        <div class="col-md-2"><input type="date" name="follow_up_date" class="form-control" required></div>
        <div class="col-md-3 mt-2"><input type="text" name="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" class="form-control"></div>
        <div class="col-md-2 mt-2"><button type="submit" class="btn btn-primary w-100">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button></div>
    </form>

    <table class="table table-bordered table-striped align-middle">
        <thead>
            <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏•‡∏ö</th>
            </tr>
        </thead>
        <tbody>
            {% for row in customers %}
            <tr>
                <td>{{ row[1] }}</td><td>{{ row[2] }}</td><td>{{ row[3] }}</td><td>{{ row[4] }}</td><td>{{ row[5] }}</td><td>{{ row[6] }}</td><td>{{ row[7] }}</td>
                <td>
                    <form action="/update_status/{{ row[0] }}" method="post" class="d-flex">
                        <select name="decision_status" class="form-select me-2">
                            <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" {% if row[5] == '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' %}selected{% endif %}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                            <option value="‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô" {% if row[5] == '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' %}selected{% endif %}>‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</option>
                            <option value="‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" {% if row[5] == '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' %}selected{% endif %}>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-success">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
                    </form>
                </td>
                <td><a href="/delete/{{ row[0] }}" class="btn btn-sm btn-danger" onclick="return confirm('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?')">‡∏•‡∏ö</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
      const ctx = document.getElementById('statusChart').getContext('2d');
      const statusChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'],
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
            data: [{{ ordered }}, {{ not_ordered }}, {{ pending }}],
            backgroundColor: ['#800000', '#808080', '#FFD700'],
            borderColor: ['#5a0000', '#666666', '#b8860b'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ' + context.parsed.y;
                }
              }
            }
          }
        }
      });
    </script>

</body>
</html>