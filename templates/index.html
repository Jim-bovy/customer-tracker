<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Chart.js ‡πÅ‡∏•‡∏∞ Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f4f9ff;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #005b96;
            margin-bottom: 30px;
        }

        canvas {
            max-width: 450px;
            margin: 20px auto;
            display: block;
        }

        form {
            text-align: center;
            margin-bottom: 25px;
        }

        input, textarea, button {
            padding: 8px;
            margin: 6px 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        input[type="text"], input[type="number"], textarea, input[type="date"] {
            width: 220px;
        }

        button {
            background-color: #007acc;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #005b96;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 90%;
            margin-top: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #d9e2ec;
        }

        th {
            background-color: #007acc;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #eef6fc;
        }

        tr:hover {
            background-color: #d7ebf9;
        }

        .inline-form {
            display: inline;
        }

        .small-btn {
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 3px;
        }

        .red-label {
            color: darkred;
            font-weight: bold;
        }

        .red-input {
            border: 1px solid red;
            background-color: #ffe6e6;
            color: darkred;
        }
    </style>
</head>
<body>

    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>

    <!-- ‚úÖ ‡∏Å‡∏£‡∏≤‡∏ü -->
    <canvas id="statusChart"></canvas>

    <!-- ‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <form method="GET" action="/">
        <input type="text" name="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" value="{{ request.args.get('search', '') }}">
        <button type="submit">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </form>

    <!-- ‚úÖ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
    <form method="POST" action="/add">
        <input type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
        <input type="text" name="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" required>
        <input type="text" name="location" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà"><br>
        <textarea name="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" rows="2"></textarea><br>
        <input type="text" name="proposal_details" placeholder="‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠ / ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠">
        <input type="number" step="0.01" name="proposal_price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠ (‡∏ö‡∏≤‡∏ó)"><br>
        <label for="follow_up_date" class="red-label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</label><br>
        <input type="date" id="follow_up_date" name="follow_up_date" class="red-input"><br>
        <button type="submit">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    </form>

    <!-- ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <table>
        <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</th>
            <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
        {% for c in customers %}
        <tr>
            <td>{{ c['name'] }}</td>
            <td>{{ c['phone'] }}</td>
            <td>{{ c['location'] }}</td>
            <td>{{ c['details'] or '-' }}</td>
            <td>{{ '{:,.2f}'.format(c['price']) if c['price'] else '-' }}</td>
            <td>{{ c['note'] or '-' }}</td>
            <td>
                {{ c['status'] or '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏ô‡∏≠' }}
                {% if c['status'] == '‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à' %}
                    <form method="POST" action="/update_status/{{ c['id'] }}" class="inline-form">
                        <input type="hidden" name="new_status" value="‡∏ï‡∏Å‡∏•‡∏á">
                        <button type="submit" class="small-btn">‚úÖ</button>
                    </form>
                    <form method="POST" action="/update_status/{{ c['id'] }}" class="inline-form">
                        <input type="hidden" name="new_status" value="‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á">
                        <button type="submit" class="small-btn">‚ùå</button>
                    </form>
                {% endif %}
            </td>
            <td>{{ c['follow_up_date'] or '-' }}</td>
            <td>
                <form method="POST" action="/delete_customer/{{ c['id'] }}" onsubmit="return confirm('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ {{ c['name'] }}?');" class="inline-form">
                    <button type="submit" class="small-btn" style="background:red; color:white;">üóëÔ∏è</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>

    <!-- ‚úÖ ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü -->
    <script>
    const customers = {{ customers_json | safe }};
    let agreed = 0, declined = 0, pending = 0;
    customers.forEach(c => {
        if (c.status === '‡∏ï‡∏Å‡∏•‡∏á') agreed++;
        else if (c.status === '‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á') declined++;
        else if (c.status === '‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à') pending++;
    });

    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['‡∏ï‡∏Å‡∏•‡∏á', '‡πÑ‡∏°‡πà‡∏ï‡∏Å‡∏•‡∏á', '‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à'],
            datasets: [{
                data: [agreed, declined, pending],
                backgroundColor: ['#28a745', '#dc3545', '#ffc107']
            }]
        },
        options: {
            plugins: {
                legend: { position: 'bottom' },
                datalabels: {
                    formatter: (value, ctx) => {
                        const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        if (total === 0) return '0%';
                        const percentage = (value / total * 100).toFixed(1);
                        return `${percentage}%`;
                    },
                    color: '#000',
                    font: { weight: 'bold' }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    </script>

</body>
</html>